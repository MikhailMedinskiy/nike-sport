name: Auto add Jira ticket to PR description

on:
  pull_request:
    types: [opened]

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    steps:
      - name: Add Jira ticket to PR description and clean up Description section
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            // Match OBT-XXXX or OBT-XXXXX pattern in the branch name
            const match = branch.match(/OBT-\d{4,5}/);
            if (!match) return;

            const jira = match[0];
            let oldBody = context.payload.pull_request.body || "";

            // --- Jira ticket section logic ---
            const jiraSectionRegex = /(## üìã Jira Ticket\s*\n)((- Ticket: \[OBT-[A-Z0-9X]{4,7}\]\([^)]+\)\s*\n*)*)/i;
            const newJiraLine = `- Ticket: [${jira}](https://entdevbcdtravel.atlassian.net/browse/${jira})\n\n`;

            let newBody;
            if (jiraSectionRegex.test(oldBody)) {
              newBody = oldBody.replace(jiraSectionRegex, `$1${newJiraLine}`);
            } else if (oldBody.includes('## üìã Jira Ticket')) {
              newBody = oldBody.replace(/(## üìã Jira Ticket\s*\n)/, `$1${newJiraLine}`);
            } else {
              newBody = `## üìã Jira Ticket\n\n${newJiraLine}${oldBody}`;
            }

            // --- Description section cleanup logic ---
            // This regex will remove the 'Description' section if nothing (except whitespace) follows it up to the next header or end of file
            newBody = newBody.replace(
              /(## üìù Description\s*\n)((?:\s|\r|\n)*)(?=(## |<!--|$))/g,
              (match, header, content, nextHeader) => {
                if (!content.trim()) {
                  // If only whitespace/newlines after header, remove the whole s
