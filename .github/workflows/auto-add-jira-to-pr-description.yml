name: Auto add Jira ticket to PR description

on:
  pull_request:
    types: [opened]

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    steps:
      - name: Add Jira ticket to PR description
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            // Match only OBT-XXXX or OBT-XXXXX pattern in the branch name
            const match = branch.match(/OBT-\d{4,5}/);
            if (match) {
              const jira = match[0];
              const oldBody = context.payload.pull_request.body || "";
              // Improved regex: matches ANY ticket line with OBT-xxxx
              const jiraLineRegex = /- Ticket: \[OBT-\d{4,5}\]\([^)]+\)\n?/g;

              // New Jira ticket line
              const newJiraLine = `- Ticket: [${jira}](https://entdevbcdtravel.atlassian.net/browse/${jira})`;

              let newBody;
              if (oldBody.includes('## ðŸ“‹ Jira Ticket')) {
                // Always remove all ticket lines after the section header to avoid duplicates
                newBody = oldBody.replace(jiraLineRegex, '');
                newBody = newBody.replace(
                  /(## ðŸ“‹ Jira Ticket(\r?\n)+)/,
                  `$1${newJiraLine}\n\n`
                );
              } else {
                // If the section header is missing â€” add it to the top
                newBody = `## ðŸ“‹ Jira Ticket\n\n${newJiraLine}\n\n${oldBody}`;
              }

              // Remove excessive newlines if any remain
              newBody = newBody.replace(/\n{3,}/g, '\n\n');

              if (oldBody !== newBody) {
                await github.rest.pulls.update({
                  ...context.repo,
                  pull_number: context.payload.pull_request.number,
                  body: newBody
                });
              }
            }
