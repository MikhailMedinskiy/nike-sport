name: Auto add Jira ticket to PR description

on:
  pull_request:
    types: [opened]

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    steps:
      - name: Add Jira ticket to PR description
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            // Match only OBT-XXXX or OBT-XXXXX pattern in the branch name
            const match = branch.match(/OBT-\d{4,5}/);
            if (!match) return;

            const jira = match[0];
            const oldBody = context.payload.pull_request.body || "";

            // Regex to match the section including all ticket lines right after the header
            const jiraSectionRegex = /(## ðŸ“‹ Jira Ticket\s*\n)((- Ticket: \[OBT-\d{4,5}\]\([^)]+\)\s*\n*)*)/;

            // The correct ticket line
            const newJiraLine = `- Ticket: [${jira}](https://entdevbcdtravel.atlassian.net/browse/${jira})\n\n`;

            let newBody;
            if (jiraSectionRegex.test(oldBody)) {
              // Replace everything after the section header with just the correct ticket line
              newBody = oldBody.replace(jiraSectionRegex, `$1${newJiraLine}`);
            } else if (oldBody.includes('## ðŸ“‹ Jira Ticket')) {
              // Header exists, but no ticket line â€” insert the ticket line right after the header
              newBody = oldBody.replace(/(## ðŸ“‹ Jira Ticket\s*\n)/, `$1${newJiraLine}`);
            } else {
              // No section header at all, add the section at the top
              newBody = `## ðŸ“‹ Jira Ticket\n\n${newJiraLine}${oldBody}`;
            }

            // Remove excessive newlines
            newBody = newBody.replace(/\n{3,}/g, '\n\n');

            if (oldBody !== newBody) {
              await github.rest.pulls.update({
                ...context.repo,
                pull_number: context.payload.pull_request.number,
                body: newBody
              });
            }
